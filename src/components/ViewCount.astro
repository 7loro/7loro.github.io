---
import { t } from '../i18n';

interface GoatCounterConfig {
  site_code: string;
  show_view_count: boolean;
}

interface AnalyticsConfig {
  enabled: boolean;
  provider: string;
  goatcounter?: GoatCounterConfig;
}

interface Props {
  path: string;
}

const { path } = Astro.props;

const analytics = import.meta.env.ANALYTICS as AnalyticsConfig;
const isEnabled = analytics?.enabled && analytics?.provider === 'goatcounter';
const goatcounter = analytics?.goatcounter;
const showViewCount = isEnabled && goatcounter?.site_code && goatcounter?.show_view_count;
const siteCode = goatcounter?.site_code || '';
---

{showViewCount && (
  <span class="view-count" data-goatcounter-path={path} data-goatcounter-site={siteCode}>
    <svg
      class="view-count__icon"
      xmlns="http://www.w3.org/2000/svg"
      width="14"
      height="14"
      viewBox="0 0 24 24"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
    >
      <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
      <circle cx="12" cy="12" r="3"></circle>
    </svg>
    <span class="view-count__number">—</span>
    <span class="view-count__label">{t('views')}</span>
  </span>
)}

<script>
  function initViewCounters() {
    document.querySelectorAll('[data-goatcounter-path]').forEach(async (el) => {
      const path = el.getAttribute('data-goatcounter-path');
      const siteCode = el.getAttribute('data-goatcounter-site');
      const numberEl = el.querySelector('.view-count__number');

      if (!path || !siteCode || !numberEl) return;

      try {
        const encodedPath = encodeURIComponent(path);
        const response = await fetch(
          `https://${siteCode}.goatcounter.com/counter/${encodedPath}.json`,
        );

        if (!response.ok) {
          numberEl.textContent = '0';
          return;
        }

        const data = await response.json();
        const count = typeof data.count === 'string'
          ? data.count.replace(/,/g, '')
          : data.count;
        numberEl.textContent = Number(count).toLocaleString();
      } catch {
        numberEl.textContent = '—';
      }
    });
  }

  initViewCounters();
  document.addEventListener('astro:page-load', initViewCounters);
</script>

<style>
  .view-count {
    display: inline-flex;
    align-items: center;
    gap: var(--spacing-xs);
    font-family: var(--font-mono);
    font-size: var(--font-size-sm);
    color: var(--text-muted);
  }

  .view-count__icon {
    opacity: 0.7;
  }

  .view-count__number {
    font-weight: 600;
  }

  .view-count__label {
    opacity: 0.8;
  }
</style>
